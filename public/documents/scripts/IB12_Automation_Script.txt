#!/bin/bash
# IB12 - Expiry Date Item Management Automation Script
# TC Name: IB12_Expiry_Date_Item_E2E_Test
# Description: Automated testing for expiry-dated items from PO to putaway

echo "================================================"
echo "IB12 - Expiry Date Item Management Test"
echo "================================================"

# Prerequisites
# - Item configured as expiry-dated in SAP
# - Min/Max expiry dates configured
# - MAWM expiry date validation enabled
# - Valid storage locations for expiry items

# Test Data
VENDOR_CODE="V10002"
ITEM_CODE="EXPIRY_ITEM_789"
PO_QUANTITY="50"
EXPIRY_DATE="2025-12-31"
WAREHOUSE_LOCATION="WH01-B-05-EXPIRY"

# Step 1: Verify Item Configuration in SAP
echo "Step 1: Verifying Item Master Data..."
curl -X GET "https://sap-api.example.com/api/items/$ITEM_CODE" \
  -H "Accept: application/json"

EXPIRY_FLAG=$(echo $response | jq -r '.expiry_dated_flag')
if [ "$EXPIRY_FLAG" != "true" ]; then
  echo "✗ ERROR: Item not configured as expiry-dated"
  exit 1
fi
echo "✓ Item configured correctly with expiry date flag"

# Step 2: Create Purchase Order with Expiry Date
echo "Step 2: Creating PO with Expiry Date..."
curl -X POST "https://sap-api.example.com/api/purchase-orders" \
  -H "Content-Type: application/json" \
  -d '{
    "vendor_code": "'$VENDOR_CODE'",
    "items": [{
      "item_code": "'$ITEM_CODE'",
      "quantity": '$PO_QUANTITY',
      "expiry_date": "'$EXPIRY_DATE'",
      "price": 15.75
    }]
  }'

PO_NUMBER=$(echo $response | jq -r '.po_number')
echo "✓ PO Created: $PO_NUMBER with Expiry Date: $EXPIRY_DATE"

# Step 3: Send ASN with Expiry Information
echo "Step 3: Sending ASN with Expiry Data to MAWM..."
curl -X POST "https://mawm-api.example.com/api/asn" \
  -H "Content-Type: application/json" \
  -d '{
    "po_number": "'$PO_NUMBER'",
    "vendor_code": "'$VENDOR_CODE'",
    "expected_items": [{
      "item_code": "'$ITEM_CODE'",
      "quantity": '$PO_QUANTITY',
      "expiry_date": "'$EXPIRY_DATE'"
    }]
  }'

echo "✓ ASN with Expiry Data Sent"

# Step 4: Validate Min/Max Expiry Dates
echo "Step 4: Validating Expiry Date Range..."
curl -X POST "https://mawm-api.example.com/api/validation/expiry" \
  -H "Content-Type: application/json" \
  -d '{
    "item_code": "'$ITEM_CODE'",
    "expiry_date": "'$EXPIRY_DATE'"
  }'

VALIDATION_STATUS=$(echo $response | jq -r '.status')
if [ "$VALIDATION_STATUS" != "valid" ]; then
  echo "✗ ERROR: Expiry date validation failed"
  exit 1
fi
echo "✓ Expiry Date within acceptable range"

# Step 5: Receive Item with Expiry Date
echo "Step 5: Receiving Item with Expiry Tracking..."
curl -X POST "https://mawm-api.example.com/api/receiving" \
  -H "Content-Type: application/json" \
  -d '{
    "po_number": "'$PO_NUMBER'",
    "received_items": [{
      "item_code": "'$ITEM_CODE'",
      "quantity": '$PO_QUANTITY',
      "expiry_date": "'$EXPIRY_DATE'",
      "location": "'$WAREHOUSE_LOCATION'"
    }]
  }'

echo "✓ Expiry-Dated Item Received"

# Step 6: Verify FEFO (First Expiry First Out) Logic
echo "Step 6: Verifying FEFO Logic..."
curl -X GET "https://mawm-api.example.com/api/inventory/fefo?item_code=$ITEM_CODE"

echo "✓ FEFO Logic Applied Correctly"

# Step 7: Execute Putaway to Expiry Zone
echo "Step 7: Executing Putaway to Expiry Storage Zone..."
curl -X POST "https://mawm-api.example.com/api/putaway/execute" \
  -H "Content-Type: application/json" \
  -d '{
    "po_number": "'$PO_NUMBER'",
    "destination": "'$WAREHOUSE_LOCATION'",
    "expiry_date": "'$EXPIRY_DATE'",
    "fefo_priority": true
  }'

echo "✓ Putaway to Expiry Zone Completed"

echo "================================================"
echo "Test Completed Successfully!"
echo "PO Number: $PO_NUMBER"
echo "Expiry Item: $ITEM_CODE"
echo "Quantity: $PO_QUANTITY"
echo "Expiry Date: $EXPIRY_DATE"
echo "Location: $WAREHOUSE_LOCATION"
echo "================================================"
